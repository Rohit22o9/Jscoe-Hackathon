/**
 * Google Apps Script Backend for IIC 2K26 Registration
 * 
 * Features:
 * - Stores form data in Google Sheets
 * - Uploads Base64 images to Google Drive
 * - Auto-generates timestamps and status
 */

const SHEET_NAME = 'Registrations';
const DRIVE_FOLDER_ID = '1Wz5fN30iV6jbNh0CpjN8DFA75jDz4fPq'; 

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000); 

  const debugLogs = [];
  function log(msg) {
    debugLogs.push(new Date().toISOString() + ": " + msg);
  }

  try {
    log("Started execution");
    const data = JSON.parse(e.postData.contents);
    
    // Get Active Spreadsheet (The one this script is attached to)
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    if (!ss) throw new Error("Script is not attached to a Spreadsheet. Please check the container.");
    
    log("Accessed Spreadsheet: " + ss.getName());
    log("Spreadsheet URL: " + ss.getUrl()); // CLICK THIS IN LOGS TO FIND DATA

    // Get Sheet
    let sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) {
      log("Sheet 'Registrations' not found, creating it...");
      sheet = ss.insertSheet(SHEET_NAME);
    } else {
      log("Found existing sheet: " + SHEET_NAME);
    }
    
    // Headers
    if (sheet.getLastRow() === 0) {
      const headers = [
        'Timestamp', 'Team Name', 'Institution', 'Institution Type', 'Country', 'State', 'PIN', 
        'Team Leader Name', 'Leader Email', 'Leader Phone', 'Team Size',
        'Member 2 Name', 'Member 2 Email', 'Member 3 Name', 'Member 3 Email', 
        'Member 4 Name', 'Member 4 Email', 'Innovation Track', 'Project Title', 
        'Project Description', 'GitHub Link', 'Transaction ID', 'Screenshot Drive Link', 'Approval Status'
      ];
      sheet.appendRow(headers);
      sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold').setBackground('#f3f3f3');
    }

    // File Upload
    let fileUrl = "No Screenshot";
    try {
      if (data.screenshot && data.screenshot.base64) {
        log("Uploading file...");
        const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
        const contentType = data.screenshot.type || 'image/png';
        const fileName = `Payment_${data.teamName.replace(/\s+/g, '_')}_${Date.now()}`;
        const decodedData = Utilities.base64Decode(data.screenshot.base64.split(',')[1]);
        const blob = Utilities.newBlob(decodedData, contentType, fileName);
        const file = folder.createFile(blob);
        fileUrl = file.getUrl();
        log("File uploaded: " + fileUrl);
      }
    } catch (driveError) {
      log("Drive Error: " + driveError.toString());
      fileUrl = "Error: " + driveError.toString(); // Don't fail the whole registration
    }

    // Row Data
    const row = [
      new Date(),
      data.teamName,
      data.college,
      data.collegeType || '-',
      data.country,
      data.state,
      data.pin,
      data.leaderName,
      data.leaderEmail,
      data.leaderPhone,
      data.teamSize || (data.m2Name ? (data.m3Name ? (data.m4Name ? 4 : 3) : 2) : 1),
      data.m2Name || '-',
      data.m2Email || '-',
      data.m3Name || '-',
      data.m3Email || '-',
      data.m4Name || '-',
      data.m4Email || '-',
      data.track,
      data.projectTitle,
      data.projectDesc,
      data.githubLink || '-',
      data.transactionId,
      fileUrl,
      'Pending'
    ];

    sheet.appendRow(row);
    SpreadsheetApp.flush(); 
    log("Row saved successfully.");

    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      message: 'Registration recorded successfully',
      spreadsheetName: ss.getName(),
      spreadsheetUrl: ss.getUrl(), // Return URL to frontend
      logs: debugLogs
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    log("CRITICAL ERROR: " + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString(),
      logs: debugLogs
    })).setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}
